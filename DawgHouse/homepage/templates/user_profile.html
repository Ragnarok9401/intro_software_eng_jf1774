<!DOCTYPE html>
<html>
  <head>
    <title>User Profile</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'profile.css' %}" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  </head>
  <body>
    <div class="top-bar">
      <a href="/" class="logo-link">
        <img
          src="{% static 'images/DHLogo.png' %}"
          alt="DawgHouse Logo"
          class="logo"
        />
      </a>
    </div>

    <div class="profile-cover">
      <img
        src="{% static 'images/msstate.jpg' %}"
        alt="{{ user.username }}'s cover photo"
      />
    </div>
    <div class="profile-content">
      <div class="profile-header">
        <img
          src="{% static 'images/profilePicture.jpg' %}"
          alt="{{ user.username }}'s profile picture"
        />
        <div class="profile-name-bio">
          <h1>{{ user.first_name }} {{ user.last_name }}</h1>
          <p>@{{ user.username }}</p>
        </div>
      </div>
      <div class="profile-layout">
        <div class="bio-container">
          <strong>Bio</strong>
          <div class="display-bio">
            <p id="bioText">{{ user.bio }}</p>
            <button id="editBioButton">Edit Bio</button>
          </div>
          <div class="edit-bio" style="display: none">
            <textarea id="bioTextarea">{{ user.bio }}</textarea>
            <button id="saveBioButton">Save</button>
            <button id="cancelBioButton">Cancel</button>
          </div>

          <div class="friends-list">
            <strong>Pack</strong>
            {% if friends_list %}
            <ul>
              {% for friend in friends_list %}
              <li>@{{ friend.username }}</li>
              {% endfor %}
            </ul>
            {% else %}
            <p>No friends yet!</p>
            {% endif %}
          </div>
        </div>

        <div class="add-bark-container">
          <form action="{% url 'post_bark' %}" method="post">
            {% csrf_token %}
            <div class="bark-input-group">
              <strong>Add a Bark</strong>
              <textarea
                name="bark_content"
                placeholder="What's on your mind?"
                required
              ></textarea>
            </div>
            <button type="submit">Post Bark</button>
          </form>
        </div>

        <!-- Barks-->
        <div class="barks-container">
          <h2>Timeline</h2>
          <ul>
            {% for bark in barks %}
            <li class="bark">
              <div class="bark-header">
                  <h3>{{ user.first_name }} {{ user.last_name }}</h3>
                  <p class="timestamp">{{ bark.timestamp }}</p>
              </div>
              <h4>@{{ user.username }}</h4>
              <hr color="maroon">
              <div class="bark-content-display">
                <p>{{ bark.content }}</p>
                <i class="fa fa-pencil show-edit-bark-form" aria-hidden="true"></i> <!-- needs backend -->
                <i class="fa fa-trash delete-bark" onclick="return confirm('Are you sure you want to delete this bark?');" aria-hidden="true"></i>
        </div>
        <div class="edit-bark-form" style="display: none;">
          <form action="#" method="post">
              {% csrf_token %}
              <textarea name="edited_bark_content" required>{{ bark.content }}</textarea>
              <button type="submit">Save</button>
              <button type="button" class="hide-edit-bark-form">Cancel</button>
          </form>
      </div>
              <div class="counters-container">
                <h4 class="counters-container">
                  <strong>{{ bark.num_likes }}</strong> Treats
                  <span class="comment-counter"><strong>0</strong> Yips</span> <!--needs backend-->
              </h4>
              
            </div>
              <hr>
              <div class="button-container">
                <form action="{% url 'give_treat' bark.id %}" method="post">
                  {% csrf_token %} {% if user in bark.treated_by.all %}
                  <button type="submit" style="background-color: rgb(70, 18, 18)"><i class="fa-solid fa-bone" style="color:white;"></i> Treat</button>
                  {% else %}
                  <button type="submit"><i class="fa-solid fa-bone" style="color:white;"></i>        Treat</button>
                  {% endif %}
                </form>
            
                <!-- needs backend -->
                <button type="button">
                    <i class="fa-solid fa-comments" style="color:white;"></i> Yip
                </button>
            
                <!-- needs backend -->
                <button type="button">
                    <i class="fa-solid fa-dog" style="color:white;"></i> Howl
                </button>
            </div>
            </li>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>



    <script>
      // you always want the DOM to load in before you script otherwise itll go wackers (hence why you place it after HTML stuff)
      document.addEventListener('DOMContentLoaded', function() {
        // event listener just grabs input/waits for a user to touch it lol
          document.getElementById('editBioButton').addEventListener('click', function(){
              document.querySelector('.display-bio').style.display = 'none'; 
              document.querySelector('.edit-bio').style.display = 'block';
          });
  
          //event listender for the cancle button
          document.getElementById('cancelBioButton').addEventListener('click', function(){
              document.querySelector('.display-bio').style.display = 'block';
              document.querySelector('.edit-bio').style.display = 'none'; // we dont want to see the edited version because we canceled
          });
  
          // save button event listener
          document.getElementById('saveBioButton').addEventListener('click', function(){
              const updatedBio = document.getElementById('bioTextarea').value; // we want the updated block (HTML)
              
            //server stuff 
              fetch('/edit_bio/', {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                      'X-CSRFToken': '{{ csrf_token }}' //django token
                  },
                  body: JSON.stringify({ //sends to json (i added to the view)
                      'bio': updatedBio
                  })
              })
              .then(response => { //error handles server response so it doesnt break 
                  if (!response.ok) {
                      throw new Error('bad response');
                  }
                  return response.json();
              })
              .then(data => {
                  if(data.success){
                    // will display if success
                      document.getElementById('bioText').innerText = updatedBio;
                      document.querySelector('.display-bio').style.display = 'block';
                      document.querySelector('.edit-bio').style.display = 'none';
                  }
              });
          });
      });
      </script>
    </body>
  </html>
  </body>
</html>
